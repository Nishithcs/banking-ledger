package main

import (
	"context"
	"fmt"
	"os"

	"github.com/Nishithcs/banking-ledger/internal/handlers"
	internal "github.com/Nishithcs/banking-ledger/pkg"
	"github.com/gin-contrib/cors"
	"github.com/gin-gonic/gin"
	"github.com/jackc/pgx/v5"
)

func main() {
	router := gin.Default()

	// CORS middleware
	router.Use(cors.New(cors.Config{
		AllowOrigins:     []string{"*"},
		AllowMethods:     []string{"GET", "POST", "PUT", "PATCH", "DELETE", "OPTIONS"},
		AllowHeaders:     []string{"Origin", "Content-Type", "Accept", "Authorization"},
		ExposeHeaders:    []string{"Content-Length"},
		AllowCredentials: true,
	}))

	ctx := gin.Context{}

	// Rabbitmq account creation
	var queue internal.MessageQueue = &internal.RabbitMQ{}

	err := queue.Connect(internal.AmqpURL())
	if err != nil {
		panic(err)
	}

	defer queue.Close()
	// MongoDB starts	
	// ctx = context.Background()
	mongoDbClient, err := internal.NewMongoDBClient(&ctx, "mongodb://myuser:mypassword@mongodb:27017", "bank")

	if err != nil {
		fmt.Fprintf(os.Stderr, "Error creating MongoDB client: %v\n", err)
		os.Exit(1)
	}

	// urlExample := "postgres://username:password@localhost:5432/database_name"
	conn, err := pgx.Connect(context.Background(), fmt.Sprintf("postgres://%s:%s@%s:%s/%s",
		os.Getenv("DB_USER"),
		os.Getenv("DB_PASSWORD"),
		os.Getenv("DB_HOST"),
		os.Getenv("DB_PORT"),
		os.Getenv("DB_NAME")))
	if err != nil {
		fmt.Fprintf(os.Stderr, "Unable to connect to database: %v\n", err)
		os.Exit(1)
	}

	defer conn.Close(context.Background())

	router.POST("/createAccount", handlers.CreateAccountHandler(&ctx, queue, "account_creator"))
	
	router.POST("/transact", handlers.TransactionHandler(&ctx, queue, "transaction_processor"))

	router.GET("/account/:accountNumber/transactionHistory", handlers.GetTransactionHistoryHandler(&ctx, mongoDbClient))

	router.GET("/account/status/:accountNumber", handlers.GetAccountStatusHandler(&ctx, conn, mongoDbClient))

	router.Run(":8080")
}
